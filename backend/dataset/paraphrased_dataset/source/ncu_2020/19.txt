本小節則針對本研究4.1 小節中共提到的4 種情境舉出對應範例與修正方式之實際 說明。以圖 39 範例來說，我們需要調整的會是第15、16 和17 號video sample，第15 號sample 做為4.1.1 小節之實際範例，而第16、17 號sample 則做為4.1.2 小節之實際範 例。 圖 39 狀況一、狀況二範例──修正前 資料來源：本研究 第15 號sample 的檔案偏移量為71147，觀察自該偏移量的前5 個Bytes 為0x00 0x00 0x0e 0xbc 0x66，可以知道這一個NALU 的大小為0xebc 也就是10 進位的3772，再加上 0x00 0x00 0x0e 0xbc 本身代表NALU 長度資訊占4 Bytes，故3772+4=3776 剛好等於於第 15 號video sample 於stsz box 中記錄的大小（3776），故可以得知該video sample 中就只有 一個NALU。又緊接NALU length 後的Byte 是0x66 是NALU Header，根據前面章節所述 可以知道該NALU 為supplemental enhancement information（SEI），是屬於Non-VCL-NALU。 因該sample 為第1 個video chunk 中的最後一個sample，又第1 個video chunk 的檔案偏 移量為168，在此video chunk 中共有15 個sample，其sample size 總和可根據stsz box 中 資訊得知為74755（上圖 39 中 chunk num 為1 的sample 對應到size 欄位數值的加總）。 如果我們將其與第1個video chunk的檔案偏移量相加可以得到數值為74755+168=74923， 惟本例中第2 個video chunk 的偏移量為79015，可以發現74923 不等於79015，從這邊我 們就可以知道兩個video chunk 間彼此不是連續排列於檔案中。故第15 號sample 的處理 方式即無法將他合併到第16 號sample 中，如將15 號sample 合併到16 號中，首先要將 16 號的sample size 調整成原15 和16 號sample 大小的加總，又第16 號sample 是第2 個 video chunk 中的第1 個sample，所以要再接著將第2 個video chunk 於檔案中的偏移量往 前調整，此舉將會使得第2個video chunk的偏移量資訊落在第1個audio chunk的區塊中。 故才無法向後合併。本研究做法是自第15 號sample 往前找尋直到發現delta time 為大於 零的video sample 標的，於本例中也就是第14 號sample，接著將第15 號sample 的sample size 合併到第14 號的sample 中（調整stsz box），緊接著刪除第15 號sample 於stsz box 以及stts box 中的紀錄，因為前述動作會導致第1 個video chunk 中的sample 數減少，故 所以也需要調整stsc box 中第1 個video chunk 與其包含的sample 個數關聯資訊。因為合 併的動作是發生在同一個video chunk 內，所以並不會影響到第1 個和第2 個video chunk 於檔案中的偏移量，換言之也就是沒有影響到stco box 之內容。 第16 號和第17 號sample 則分別落在檔案偏移量79015 以及79028 上，分別檢查以 各sample偏移量為起始的前5個Bytes資料可以分別得到0x00 0x00 0x00 0x09 0x67與0x00 0x00 0x00 0x04 0x68，則可知道第16 號sample 中的NALU 為長度占9 Bytes 的sps，而第 17 號sample 中的NALU 為占4 Bytes 的PPS，兩者都是Non-VCL-NALU。另外stsz box 中 描述對應到的sample size 分別是13 與8，剛好都比NALU 長度多4 Bytes，到這邊就可 以知道第16 號和第17 號sample 中都各只有一個NALU 於其中。由於分別是第2 個video chunk 中的第1 和第2 個 video sample，與前一個video chunk 又沒有連續排列於檔案中， 故會採用向後合併的方式處理。作法為往後找尋delta time 大於0的video sample的標的， 以本例來說則是第18 號sample。作法為將第16 和第17 號sample 的sample size 加到第 18 號sample 對應的stsz box 紀錄中，接著刪除掉第16 和17 號sample 於stsz box 和stts box 中的紀錄，因為前述動作會導致第2 個video chunk 內的sample 數減少2 個，故也要將 stsc box 中第2 個video chunk 對應的sample 個數也減2。至於stco box 部分，因為合併的 動作並沒有影響到第2 個video chunk 於檔案中的偏移量資訊，故不需調整。 前面3 個 video sample 的調整中，我們都尚未提到stss box 的調整方式，因stss box 為存放I-Frame 存放於哪一個video sample 中的資訊，如果因為合併動作導致video sample 數減少，則就需要重新定位I-Frame 於video sample 中的位置。於本例中在執行任何合併 動作之前I-Frame 是落在第1 和第18 號video sample 中，執行第15、16 和17 號sample 的合併動作並不會對原第1 號sample 的序位產生影響，但是就會對第18 號之後的sample 產生影響，故我們要做的即為更新原I-Frame 所在的sample index，因為我們做了合併動 作後它的序列號碼在新的sample 排列描述中它所屬於的序列號碼以本例中因為原15 號 合併到原14 號中，原16、17 號合併到原18 號中，以整體video sample 序列來說會少掉 3 個sample 數，故原第18 號sample 在新的sample 排列描述中會改變成為第15 號sample。 這邊仍要補充我們對於原始收容進來的碼流中並沒有做任何變更，只是用不同方法去描 述一個相同H.264 碼流的播放結構。經過修正後MP4 中video sample 的結構如下圖所示， 可以看到第15 號sample 的大小為是原16、17 和18 號sample 的總合，而第14 號sample 的大小則是原第14 和15 號sample 的總合，至於video chunk1 和2 的offset 仍然和先前一 樣分別是168 以及79015。 圖 40 狀況一、狀況二範例──修正後 資料來源：本研究 下圖 41 為4.1.3 節修正範例，於本例中需要調整的是第2868 號video sample，由於 2868 號sample 是第186 號video chunk 中的弟一個sample，其中包含一個SEI 類型的NALU， 因為和第185 號video chunk 不連續而且第2868 號sample 已經是檔案中最後一筆video sample，所以既不可以往前也不可以往後合併。故做法為將stsc box 中對應到186 號video chunk 的紀錄刪除，以及同步刪除stsz、stts box 中對應2868 號sample 的紀錄，最後，stco box 中對應的到video chunk 第168 號的紀錄也需跟著移除。Stss box 於本例中沒有影響， 因為沒牽扯到I-Frame 的re-indexing 所以不需要調整。 圖 41 狀況三範例──修正前 資料來源：本研究 下圖 42 為4.1.4 節修正範例，以本例中需要調整的是第15 號sample，該sample 落 在第1 個 video chunk 中的最後，內包含一個SEI，是Non-VCL-NALU，因為第1 個和第 2 個 video chunk 是連續排列在檔案結構中，所以我們就可以將第15 號sample 往第16 號 sample 合併。因第16 號sample 已經落到第2 個video chunk 中，故當我們將15 號sample 合併到第16 號中後，會讓原15 號sample 也算是落在第2 個video chunk 中，所以需將紀 錄於stco box 中的第2 個video chunk 檔案偏移量要更新成為原偏移量減去第15 號sample 的大小後的結果，接著將原第16 號於stsz box 中紀錄的sample size 更新成為原size 再加 上第15 號sample 於stsz box 紀錄的的大小，接著刪除原15 號sample 於stsz box 中對應 到的紀錄。因為前述動作會讓第1 個video chunk 內減少1 個sample 數量，故針對stsc box 中對應到第1 號video chunk 的紀錄其原值需要減1。再接著刪除於stts box 紀錄中對應到 原第15 號sample 的sample delta time 紀錄。 因為原15 號sample 對應到stsc、stts 與stsz box 的紀錄皆被刪除會導致原本的第16 號sample 經過這樣的調整後變成後來的第15 號sample，所以原先紀錄個I-Frame 出現位 置的stss box 也會因為前述調整，需要重新對每個I-Frame 出現在哪個sample 中來重新定 位（re-index）。以本例來說原本第16 號sample 是有包含I-Frame 的可是因為原第15 sample 已不存在，所以原本的第16 號sample 就會變成之後的第15 號sample，故在stss box 中 只要是落在原第15 號sample 之後出現的I-Frame，其對應到的sample index number 都必 須做re-index，修正後結果如圖 43 所示。 圖 42 狀況四範例──修正前 資料來源：本研究 圖 43 狀況四範例──修正後 資料來源：本研究 第五章 結論 本章將針對研究結論、對個案公司影響以及研究限制議題做說明。
