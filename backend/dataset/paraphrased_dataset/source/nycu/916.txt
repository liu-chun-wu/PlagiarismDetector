在考量HAProxy、Keepalived 與NCTU OAuth 的整合處理上[21] [22]，整體系統乃建構於VMWare vSphere 虛擬化平台上運作，故建 置的過程皆以如何於虛擬化平台環境運作順暢為優先考量。首先： HAproxy 的HA 機制（Keepalived）[23]需使用VRRP 協定運作，該協 定運作需於內、外網路介面上再各建立一組Master 與Backup HAProxy 共用的虛擬位址（Virtual IP Address，簡稱為VIP），因為是 共用的網路位址，故HAProxy 系統（包含HAProxy master 與 HAProxy backup）的網路需一致連結於同一網段，以利於在Failover 動作切換後仍然具有有效的Gateway 出口，故本論文實驗環境在 HAProxy 虛擬機建構於VMWare 虛擬平台後亦把網路設置於相同網 段的vSwitch[24]（如下圖6 與圖7）上。另外，考量分離放置後端的 多台NCTU-OAuth 主機以分散風險，故以2 處虛擬平台各擺放了3 台總共6 台的NCTU OAuth 虛擬機以進行實驗測試。所以除了虛擬 平台-A 放置了2 台HAProxy 虛擬機與3 台NCTU-OAuth 外，於虛擬 平台-B 另外再放置了3 台NCTU-OAuth，這六台虛擬機網路則以 Private IP 與HAProxy 的內網界面連結，最後於HAProxy 上啟用負載 平衡演算法，以達到整體NCTU-OAuth 服務的最大效能與可用性。 HAProxy 與NCTU-OAuth 最後整合完成的拓墣架構如下圖5 所示。 圖 5 NCTU OAuth 運作架構拓樸圖 於虛擬平台建立系統環境則描述如下步驟進行： (1) 創建2 台虛擬機分別作為HAProxy master 與HAProxy backup，並 利用keepalived 軟體實現HAProxy 的VRRP Cluster 架構，該2 台虛擬 機的虛擬硬體資源表如下表4 所示。 表 4 HAProxy 虛擬機虛擬硬體規格與數量 虛擬硬體 數量與規格 CPU Intel Xeon 2.1GHz * 2 Memory 2GB HDD 20GB Network Card VMNIC 3 – 10Gbps * 2 (2)建立後端服務網路連線所使用Private IP 網段（192.168.10.0/24） vSwitch 網路環境，虛擬平台-A 與虛擬平台-B 設定完成畫面如下圖6 與圖7 所示。 圖 6 虛擬平台-A vSwitch 網路環境 圖 7 虛擬平台-B vSwitch 網路環境 (3)在虛擬平台所提供的虛擬機與網路建置完成後，為完成外部 Public IP 網路流量可以連線至後端Private IP 網段中的NCTU OAuth 服務，需要對HAProxy 平台進行設定，指定後端NCTU OAuth 主 機，需一致同步HAProxy Master 與Backup 主機的設定檔，其設定檔 如下圖8 所示： 圖 8 HAProxy 設定檔 在以上所述HAProxy 搭配Keepalived 軟體結合NCTU OAuth 完 成後，基本上NCTU OAuth 系統運作已具有HA 與Load Balance 的能 力可使服務持續運作，接下來就以Jmeter [25] [26] [27]施以壓力測試 以證實運作時的可靠性。 四. 系統建置成果與分析 在本章節中我們會把系統建置完成後的運作成果呈現於如下章 節，說明此架構在HA 與Load balance 功能的運作情況，並於4.3 節 說明Jmeter 效能測試結果，HAProxy 的Load balance 演算法，考量靜 態演算法需設定參數值且較局限於特定用途，故不於本篇論文中進 行評估，乃採用HAProxy 所提供的動態負載平衡演算法：Round Robin 與Lease connections 兩項演算法進行模擬測試。
