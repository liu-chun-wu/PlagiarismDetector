在HAProxy 的Load balance 架構中，前端會有VRRP 協議共用的 VIP，以此VIP 作為後端相同性質的數台主機Reverse Proxy IP，在運 作過程中我們由外部網路傳送請求至VIP（140.113.199.130）時， HAProxy 將觀察傳入的流量，透過所設定的負載平衡演算法把同時 傳入的數筆請求分散轉派至後端所設定好的數台Server 上，再由數 台Server 各自處理連線進來的請求，再回傳處理後的結果，如此在 同時間分散大量的連線至後端數台Server 上運作，即可使服務不致 因忙碌處理連線的請求而來不急在有效時間內回應，更致使服務回 應Timeout 造成中斷。另外；為確保在前端HAProxy VIP 轉派請求至 後端Server 時，後端Server 是維持良好的運作模式，不致因請求傳 送至後端Server 時發生後端Server 無法運作的狀況，故於HAProxy 上設定對後端Server 進行Health check 設定，每5 秒進行一次HTTP POST Request，接收到回傳的HTTP Status Code 為200，代表請求已 被伺服器接受並正常處理，確認伺服器狀態正常，但如回傳其餘的 HTTP Status Code 或未回傳，則視同Server 異常，即會暫時剔除後端 Load balance cluster erver 名單，不進行Load balance 演算法分派請求 流量，待於Health check 再次確認Server 狀態正常後，才會再把 Server 加回後端Load balance cluster server 名單中繼續作為Load balance 分派請求流量的Server 之一，而Health check 在HAProxy 判斷 後端Server 是否正常的依據的設定為3 次錯誤的Health check 確認為 Server 異常，於後端Server 清單中剔除，於本平台設定的時間為5(s) * 3 = 15(s)的時間判定為異常，而判斷恢復正常則是由異常狀態連續 接收到2 次正常的Health check 則確認Server 恢復正常，重新加回於 後端Server 清單中，於本平台設定的時間為5(s) * 2 = 10(s)的時間判 定為恢復正常。 以下則列出上述功能的驗證成果： ●Load balance：於HAProxy 上設定負載平衡演算法為Round Robin， 開啟後端4 台NCTU OAuth Server 的主控台介面進行監看，利用 Jmeter 進行模擬同時50 次的外部Request，確認Round Robin 負載平 衡演算法正常分派Request 至後端6 台NCTU OAuth，下圖9 則顯示 為前4 台的運作結果。 圖 9 HAProxy Load balance 功能測試結果 ●HAProxy 後端伺服器Health check：於HAProxy 設定cluster Servers 共有6 台NCTU-OAuth，將於VMWare vSphere 手動切斷Cluster 中一 台VM（NCTU-OAuth3）的對外網路，模擬該台伺服器因故離線不回 應，於HAProxy 所提供的後台觀測到測試前Health check 進行Layer9 的測試結果為接收到後端Server 回傳的HTTP Status code 200 皆正常 狀態（如下圖10 所示），在測試開始後，HAProxy 進行3 次Health check 失敗，隨即被標註為Layer4 離線狀態（如下圖11 所示），確認 Health check 確實發揮作用，監控後端伺服器是否可正常運作。 圖 10 HAProxy Backend Server Load balance - 功能測試前 圖 11 HAProxy Backend Server Load balance - 功能測試後
