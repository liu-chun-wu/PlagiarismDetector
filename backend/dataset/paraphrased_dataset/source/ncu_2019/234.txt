股價與基本面資料處理系統 此子系統包含流程步驟1~3，負責處理股價資料及公司財務因子以便日後做績效回 測，我們使用 Compustat 資料庫，取得1998 年至2016 年共19 年之財務資料，作為 日後程式交易回測的歷史資料來源，並計算選股樣本中各間公司每年基本面因子數 值，排名後等分切割，參考謝昀峻（2018）之研究，將因子分成 10 等分能使得排名 與獲利之間具有較好的相關性，並且根據該研究之未來建議，從Yahoo! Finance 取得 股價，將原本以財報計算動量面的做法，改以用每日股價進行計算，等分法處理後結 果示意圖如下表 3，為讓後續系統能獨立存取排名結果，將此資料表存入資料庫。 表 3、基本面資料處理過後資料表 年 分 股票 代號 公司 名稱 因子1： 值 因子1： 排名 … 因子30： 值 因子30： 排名 … APPL APPLE INC 0.43 MMM 3M CO 0.82 … 投資組合及策略績效回測系統 此子系統包含流程步驟4~13，使用Amibroker 與Python 進行策略參數最佳化及投 資組合的績效回測，本研究投組中有七項重要的變數，除了原有的技術面交易策略及 其參數設定、資金配置法、基本面因子（擴充至30 個）及其排名、與最大持有股數 外，另擴充一個資金再投入法做為新的變數，設定如下表 4 所示。 表 4、投資組合所有變數 技術面策略 買入持有 凱特通道 參數設定 買入持有無參數 • 固定參數套用至多商品 • 個股最佳化參數 資金配置法 平均投入資金法 • 平均投入資金法 • 平均ATR 風險投入法 • 平均標準差風險投入法 資金再投入法 (新增變數) • 不再投入 • 年複利再投入 • 不再投入 • 年複利再投入 基本面因子 共30 種 因子排名 1-10 名（優至劣） 最大持有股數 10、20、60、120、180 技術面策略能協助投資人判斷買賣時間點，並且有些策略可進一步配合最佳化參 數，以凱特通道為例，能根據過去資料計算出每一檔股票適合的最佳上、下通道及均 線參數。 資金配置法決定了每檔股票要投入多少金額，本研究根據Rishi K Narang 著作使用 三種資金投入法，包含：平均投入資金、採用真實區間ATR 計算風險之平均風險投入 法、採用標準差計算風險之平均風險投入法。 資金再投入方法有兩種，一為不再投入，也就是投資人持有每筆交易的獲利，不 再進行投資，第二種為年複利再投入，投資人每年年初將過去一年交易獲利再次投入 本金中，進行加碼。 基本面因子排名提供適合投資的股票集合，本研究使用Richard Tortoriello （2009）提出之三十項基本面因子作為指標排名，刪去當年缺少財務資料的公司後， 依表現優至劣切割成10 等分（每1 等份約有170 至180 檔股票）且標記其排名。 最大持有股數則代表投資人最多可以擁有幾檔股票，參數設定由最小持有 10 股 至整個等分全部持有為 180 股。 如同前述，為使得投資組合能夠自動化結合基本面與技術面分析，並且達成可擴 充之目的，本系統建立物件導向化的投資組合模型，共分為三部分：多投資組合（類 別名稱：MultiPortfolio）、等分法下可分析多投組（類別名稱：AnalyzableMP）、等分法 下可分析單一投組（類別名稱：AnalyzablePortfolio），上層多投資組合包含所有變數的 列表，下層類別則是可以藉由讀取上層的變數列表來產生單一投組，類別圖如下圖 10，類別參數包含建構投資組合的七項變數，當要擴充或修改投組參數時只需修改 MultiPortfolio 下的參數即可，其中等分法下多投組及等分法下單一投組類別皆有其詳 細計算績效之方法，可直接呼叫以進行各單一投組投資組合績效分析，無須手動修改 每一項參數設定。 其中變數名稱stocks 代表選股樣本集合；strategy 為技術面策略代號；variable 為 參數設定代號；investment 為資金配置法代號；reinvestment 為資金再投入法代號； factor、section 為基本面因子代號及其排名；最後posqty 表示此投組最大持有股數。 圖 10、投資組合模型類別圖 而為了改善原有於Amibroker 手動載入batch 檔的回測程序，必須先了解 Amibroker 運作方式，做法為使用者提供回測時間、可執行之分析專案檔（apx）及欲 分析之商品，交由Amibroker 進行回測，然而原本若要進行多商品投組回測，必須多 次手動更改商品或投資組合參數值，如同前述本研究使用凱特通道做為其中一種技術 交易策略並考慮套用個股最佳化後參數，因此需要一套使更換商品更有效率的流程， 謝昀峻（2018）已提出使用Python 依據apx 檔案建立batch 檔案後，至Amibroker 開 啟檔案，使其自行根據檔案內容設定進行回測，然而本研究希望能用更自動化的方 式，因此針對原有流程稍作修改，先由 Amibroker 取得「單一策略參數最佳化樣本 apx」後，由 Python 程式直接呼叫 Amibroker 讀取apx 檔案同時指定商品進行參數最 佳化，輸出不同參數下之獲利，再透過 Python 程式得到個股最佳化參數並彙整成個 股最佳化參數報表，供後續投組回測使用，設計流程如圖 11。 圖 11、自動化個股單一策略參數最佳化系統設計 並且本系統在回測技術面策略時也先從 Amibroker 取得「技術策略回測樣本 apx」，再基於投資組合模型，利用 Python 程式設計複寫「技術交易策略」、「參數設 定」數值，生成多支「可執行技術策略回測apx」，接著由Python 程式呼叫 Amibroker 讀取 apx 檔案同時更換商品，依照apx 內容選擇交易策略，決定是否需讀取流程 （6.1）至（6.3）生成的個股最佳化參數，接著取得所有股票過去在不同技術面策略決 策下的交易時間點，並匯出成csv 檔案，圖 12 以凱特通道策略為例表示apx 內容參數 設定。 圖 12、自動化技術策略回測系統設計 取得在不同技術面策略下每檔股票的交易紀錄後，交由Python 依據投資組合變數 指定基本面因子排名找出每個時間點可購買的股票，確認目前手中剩餘金額後，以不 同的最大持有股數及資金配置法，將資金分配至每一筆交易中，計算實際投入金額及 購買股數，完成每一個單一投組選股，計算每筆交易獲利金額後將該投組交易紀錄匯 出成投組csv 檔案並存入資料庫提供分析使用，檔案命名方式設計如圖 13 所示。 圖 13、投資組合檔案命名方式 投資組合績效分析系統 此部分包含流程步驟14~15，針對績效回測結果作分析，使投資人能了解投組中不 同變數對獲利與風險的影響，包括敘述性統計分析、迴歸分析、獲利來源分析與關鍵 績效指標分析。迴歸分析是為找出在等分法下不同基本面因子之等分排名，與獲利是 否具有相關性，預期找出排名越前面則獲益越高的基本面因子。 進行關鍵績效指標分析的目的是希望讓投資人能迅速比較獲利與風險，因此將評 估指標（淨利、最大交易虧損及夏普比率）數值根據優至劣做數值正規化，使每一評 估指標得到1 至10 的分數，分數越高代表該指標表現越好，以此做為比較。 獲利來源分析試圖找出較穩定的投資組合，若少數幾支股票佔了大部分的獲利比 例，則可能此投組具有較大的風險，相反的，若是獲利配置分散，則可能代表這是比 較穩定的投資組合。 除上述三種分析之外，本系統也利用敘述統計資料計算更完整的回測結果，包含 複合平均投資報酬率、最大價值虧損 、獲利因子、獲利標準差、及夏普比率，分析項 目如圖 14。 圖 14、分析不同變數對獲利與風險的影響 視覺化呈現系統 最後流程步驟16~17，本研究預期能讓投資人簡化投資判斷流程，為此使用 Jupyter Notebook 做為平台將績效分析以視覺化圖表呈現，由於Jupyter Notebook 可整 合程式說明、程式碼及輸出結果於一個頁面，因此本系統將說明及指令寫在此平台 上，提供使用者以指令查看分析結果，視覺化圖表部分包含迴歸分析比較圖（以折線 圖呈現）、獲利來源分析圖（以圓餅圖呈現）以及關鍵績效指標分析比較圖（以折線圖 呈現）。
